<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Database Unit Testing with tSQLt in Azure Data Studio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }

    h1, h2 {
      color: #2C3E50;
    }

    pre {
      background-color: #2C3E50;
      color: #fff;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }

    code {
      font-size: 1.2em;
    }

    hr {
      border: 0;
      border-top: 1px solid #ccc;
      margin: 20px 0;
    }

    .image-container {
      text-align: center;
      margin: 20px 0;
    }

    .image-container img {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
    }

    .code-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 1.5em;
      color: #34495E;
      margin-bottom: 10px;
    }

    .description {
      margin: 10px 0;
    }
  </style>
</head>
<body>

<h1>SQL Database Unit Testing with tSQLt in Azure Data Studio</h1>

<hr>

<h2 id="creating-the-test-setup">Setting Up the Test Environment</h2>

<p class="description">
  I started by setting up the database testing environment in Azure Data Studio using <code>tSQLt</code>. I created an "expected" table with some test data and a stored procedure called <code>GetCustomerOrderDetails</code> to retrieve customer orders. The purpose was to compare the output of this stored procedure with the expected values to confirm its correctness.
</p>

<div class="code-section">
  <h3 class="section-title">Step 1: Create Expected Table</h3>
  <pre><code class="lang-sql">
    -- Drop the existing table if it exists
    IF OBJECT_ID('expected', 'U') IS NOT NULL
        DROP TABLE expected;

    -- Create Expected Table
    CREATE TABLE expected (
        OrderQty SMALLINT,
        Name NVARCHAR(200),
        ListPrice NUMERIC(6, 2)
    );

    -- Insert test data into expected table
    INSERT INTO expected (OrderQty, Name, ListPrice)
    VALUES
        (23, 'Classic Vest, S', 63.50),
        (11, 'Water Bottle - 30 oz.', 4.99),
        (12, 'Sport-100 Helmet, Black', 34.99),
        (15, 'Short-Sleeve Classic Jersey, XL', 53.99),
        (16, 'Short-Sleeve Classic Jersey, L', 53.99),
        (17, 'Bike Wash - Dissolver', 7.95);
  </code></pre>
</div>

<p class="image-container">
  <img src="https://raw.githubusercontent.com/nbahador/nbahador.github.io/main/assets/img/fig14.png" alt="Expected Table Setup" width="800">
</p>

<hr>

<h2 id="test-case-setup">Test Case Setup: Creating 'Actual' Table</h2>

<p class="description">
  I created a temporary table called "actual" to store the data after executing the stored procedure. Both the "actual" and "expected" tables had the same schema. I dropped the existing "actual" table if it existed, then created a new one with columns for "OrderQty", "Name", and "ListPrice".
</p>

<div class="code-section">
  <h3 class="section-title">Step 2: Create the 'Actual' Table</h3>
  <pre><code class="lang-sql">
    -- Drop the existing table if it exists
    IF OBJECT_ID('actual', 'U') IS NOT NULL
        DROP TABLE actual;

    -- Now, create the new table
    CREATE TABLE actual (
        OrderQty SMALLINT,
        Name NVARCHAR(200),
        ListPrice NUMERIC(6, 2)
    );

    -- Declare a variable to store the customer ID
    DECLARE @custid SMALLINT;
    SET @custid = 29796;

    -- Insert data into the actual table by executing the stored procedure
    INSERT INTO actual
    EXEC [SalesLT].GetCustomerOrderDetails @custid;
  </code></pre>
</div>

<p class="image-container">
  <img src="https://raw.githubusercontent.com/nbahador/nbahador.github.io/main/assets/img/fig16.png" alt="Actual Table Setup" width="800">
</p>

<hr>

<h2 id="comparison-between-actual-and-expected">Comparing 'Actual' and 'Expected' Tables</h2>

<p class="description">
  I used the <code>tSQLt.AssertEqualsTable</code> stored procedure to compare the data in the "actual" table with the data in the "expected" table.
</p>

<div class="code-section">
  <h3 class="section-title">Step 3: Compare Tables with AssertEqualsTable</h3>
  <pre><code class="lang-sql">
    EXEC tSQLt.AssertEqualsTable expected, actual;
  </code></pre>
</div>

<p class="image-container">
  <img src="https://raw.githubusercontent.com/nbahador/nbahador.github.io/main/assets/img/fig17.png" alt="AssertEqualsTable Execution" width="800">
</p>

<hr>

<h2 id="creating-and-running-test">Creating and Running the Test Case</h2>

<p class="description">
  I created a test class to contain the test case by executing the <code>tSQLt.NewTestClass</code> stored procedure with the name 'testSalesLT'.
</p>

<div class="code-section">
  <h3 class="section-title">Step 4: Create Test Class</h3>
  <pre><code class="lang-sql">
    EXEC tSQLt.NewTestClass 'testSalesLT';
  </code></pre>
</div>

<p class="description">
  Then, I created a test stored procedure called <code>testGetCustomerOrderDetails</code> in the <code>SalesLT</code> schema. The procedure ensured that any pre-existing tables named "actual" and "expected" were dropped using the <code>IF OBJECT_ID</code> check. It then proceeded to create the "expected" table, inserted test data, and compared the tables using <code>tSQLt.AssertEqualsTable</code>.
</p>

<div class="code-section">
  <h3 class="section-title">Step 5: Create Test Procedure</h3>
  <pre><code class="lang-sql">
    CREATE OR ALTER PROCEDURE testSalesLT.[testGetCustomerOrderDetails]
    AS
    BEGIN
        IF OBJECT_ID('actual') IS NOT NULL DROP TABLE actual;
        IF OBJECT_ID('expected') IS NOT NULL DROP TABLE expected;

        ---- Create Expected Table -----
        CREATE TABLE expected (
            OrderQty SMALLINT,
            Name NVARCHAR(200),
            ListPrice NUMERIC(6, 2)
        );

        INSERT INTO expected (OrderQty, Name, ListPrice)
        VALUES
            (23, 'Classic Vest, S', 63.50),
            (11, 'Water Bottle - 30 oz.', 4.99),
            (12, 'Sport-100 Helmet, Black', 34.99),
            (15, 'Short-Sleeve Classic Jersey, XL', 53.99),
            (16, 'Short-Sleeve Classic Jersey, L', 53.99),
            (17, 'Bike Wash - Dissolver', 7.95);

        ------ Execution ------
        CREATE TABLE actual (
            OrderQty SMALLINT,
            Name NVARCHAR(200),
            ListPrice NUMERIC(6, 2)
        );

        DECLARE @custid SMALLINT;
        SET @custid = 29796;

        INSERT INTO actual
        EXEC  [SalesLT].GetCustomerOrderDetails @custid;

        ------ Assertion ------
        EXEC tSQLt.AssertEqualsTable expected, actual;
    END;
    GO
  </code></pre>
</div>

<p class="image-container">
  <img src="https://raw.githubusercontent.com/nbahador/nbahador.github.io/main/assets/img/fig18.png" alt="Test Procedure Creation" width="800">
</p>

<hr>

<h2 id="running-test-case">Running the Test Case</h2>

<p class="description">
  I ran the test case using the following command:
</p>

<div class="code-section">
  <h3 class="section-title">Step 6: Execute Test Case</h3>
  <pre><code class="lang-sql">
    EXEC tSQLt.Run testSalesLT;
  </code></pre>
</div>

<p class="description">
  The test returned the following results, indicating that the stored procedure <code>testGetCustomerOrderDetails</code> had produced the correct output, and the test case successfully passed.
</p>

<p class="image-container">
  <img src="https://raw.githubusercontent.com/nbahador/nbahador.github.io/main/assets/img/fig19.png?raw=true" alt="Test Results" width="800">
</p>

</body>
</html>
